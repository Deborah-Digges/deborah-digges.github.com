---
title: "Gatsby Up & Running: Creating a CD Pipeline"
---
<!-- Continuously deploy your Gatsby site to GitHub pages using TravisCI -->

In my [previous post](https://deborah-digges.github.io/2020/09/16/Jekyll-to-Gatsby), I walked through how I migrated my crufty Jekyll site to Gatsby. I talked briefly about how I deployed the new site to GitHub Pages, but was resolved to write a separate post to delve into the specifics.

## Why GitHub Pages?

I've always used GitHub pages to host my blog because it's lightweight and integrates seamlessly with GitHub workflows. It is allows some configuration, like adding a custom domain that makes it sufficient for my current static site hosting needs.


## Deploying Locally

Before pushing to GitHub Pages, I added an entry to the `scripts` tag in `package.json` which creates a production-ready build for my Gatsby site.

```
"scripts": {
  ...
  "build": "gatsby build",
}
```

```npm run build``` will build the site and place the generated assets in a folder called `public`. Copying this `public` folder to any HTTP server would effectively deploy my site to that server.

For example, running these commands will start an HTTP server serving the assets in `public`.

```
npm install -g http-server
cd public
http-server
```

```
➜  public git:(master) ✗ http-server
Starting up http-server, serving ./
Available on:
  http://127.0.0.1:8082
  http://10.10.10.10:8082
  http://192.168.13.12:8082
```

Navigating to `http://localhost:8082` would take me to a local deployment of my site!


## Deploying to Github Pages

### Setting up Github Pages

![GitHub Repository](../images/github-repository.png)

I headed to my GitHub repository's settings page and scrolled down to the `GitHub Pages` section.


I did not want the files generated by the Gatsby build process to clutter up my `master` branch so I chose the `gh-pages` branch as the source branch for my GitHub Pages site. Any static site I pushed to this branch would then be published at `deborah-digges.github.io`. I also liked the fact that `Enforce HTTPS` was enabled by default. All the security!

![GitHub Pages Config](../images/github-pages-config.png)

### Deploying Manually

The simplest way to "deploy" the site would be to build the site and push only the `public` folder to the `gh-pages` branch on Github.

This would require a rather awkward sequence of commands

```
git checkout -b gh-pages

gatsby build

# Temporarily move
mv public /tmp

# Remove all other files
rm -r *

# Move the contents of the public folder
cp -r  /tmp/public/* .

git commit -m "Release new version of blog"

git push origin gh-pages
```

That's a mouthful and it's easy to go and accidentally nuke your whole computer with commands like `rm -r *`. It's a good thing the [gh-pages](https://www.npmjs.com/package/gh-pages) package exists to save us from ourselves.

It took me a few, quick steps to get it set up:

- First, I added the dependency to my project

```
yarn add gh-pages
```

- I then added the `homepage` property in `package.json` to let `gh-pages` know where my repository was located.

```
{
  ...
  "homepage": "deborah-digges.github.io",
  ...
}
```
- I added another script `deploy` to my `package.json` which does a `build` and then pushes the `public` folder to the `gh-pages` branch of my repository on Github.

```
"scripts": {
  "build": "gatsby build",
  "deploy": "npm run build && gh-pages -d public",
}
```

And voila! I was able to deploy my site manually from my computer using the `npm run deploy` script. My site was then up and running at [deborah-digges.github.io](http://deborah-digges.github.io/)

## ✨Continuously✨ Deploying

Continuous Integration and Continuous Deployment ([CI & CD](https://www.atlassian.com/continuous-delivery/principles/continuous-integration-vs-delivery-vs-deployment)) are the hallmarks of operational efficiency that every project strives towards. I wouldn't want to be deploying a site manually from my laptop on a Friday afternoon.

I decided to continously deploy my site, which means that every new commit would automatically be deployed to my GitHub Pages site. This is exciting, but I have bypassed an important step which is having automated tests for my site to ensure that a bad commit does not bring down my site. However, I decided to live *dangerously* and keep the testing of my Gatsby site for a future blog post.

### Continously Deploying with Travis CI

I decided to go with Travis since it seemed simple enough to get started with.

### Signing Up

I signed up on the [Travis CI](https://travis-ci.org/) website with my GitHub account and consented to sharing my GitHub data with Travis.

### Enabling the Repository

I then headed to the [repositories](https://travis-ci.org/account/repositories) page and enabled builds for the `deborah-digges.github.io` repository.

![Travis Toggle](../images/travis-toggle.png)

### Add travis.yml file

I added a `travis.yml` file to the root of my repository to tell Travis what to do on every commit to `master`.

```
language: node_js
before_script:
  - npm install -g gatsby-cli
node_js:
  - "10"
script: git config --global user.email $GH_EMAIL 2> /dev/null &&
  git config --global user.name $GH_USERNAME 2> /dev/null &&
  git remote set-url origin "https://${GH_USERNAME}:${GH_TOKEN}@github.com/deborah-digges/deborah-digges.github.io.git" 2> /dev/null &&
  yarn install && yarn run deploy 2> /dev/null
```

The `script` tag is essentially running the `yarn run deploy` step that we previously used to deploy our site locally. It is doing some additional configuration to give the Travis CI the right access to push to my GitHub repository.

I told the `git` client installed on Travis CI who I was.
```
git config --global user.name $GH_USERNAME
git config --global user.email $GH_EMAIL
```

To provide access to the script, I embedded my [Github Token](https://docs.github.com/en/github/authenticating-to-github/creating-a-personal-access-token) environment variable in the remote URL:

```
git remote set-url origin "https://${GH_USERNAME}:${GH_TOKEN}@github.com/deborah-digges/
```

So, where are these environment variables coming from?

### Configuring Travis Environment Variables


I headed to my repository settings and made the following environment variables available to my script

![Travis Environment Variables](../images/travis-env-var.png)


It took me a few attempts to get this right, but I am proud to say that my site is now being continously deployed to GitHub pages on every commit to the `master` branch of my repository.

![Travis Failed Attempts](../images/travis-failed-attempts.png)



This was a lot of work, and in my quest to search for a simpler solution, I will explore using a GitHub Action to continously deploy my site. Stay tuned for more dangerous living!








